version: "3.9"

services:
  zookeeper:
    image: bitnami/zookeeper:3.9
    environment:
      - ALLOW_ANONYMOUS_LOGIN=yes
    ports:
      - "2181:2181"

  kafka:
    image: bitnami/kafka:3.6
    depends_on:
      - zookeeper
    ports:
      - "9092:9092"
    environment:
      - KAFKA_BROKER_ID=1
      - KAFKA_CFG_ZOOKEEPER_CONNECT=zookeeper:2181
      - KAFKA_CFG_LISTENERS=PLAINTEXT://:9092
      - KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT://kafka:9092
      - ALLOW_PLAINTEXT_LISTENER=yes

  ordering-db:
    image: postgres:15
    environment:
      - POSTGRES_DB=ordering
      - POSTGRES_USER=ordering
      - POSTGRES_PASSWORD=ordering
    ports:
      - "5432:5432"

  restaurant-db:
    image: postgres:15
    environment:
      - POSTGRES_DB=restaurant
      - POSTGRES_USER=restaurant
      - POSTGRES_PASSWORD=restaurant
    ports:
      - "5433:5432"

  notification-db:
    image: postgres:15
    environment:
      - POSTGRES_DB=notification
      - POSTGRES_USER=notification
      - POSTGRES_PASSWORD=notification
    ports:
      - "5434:5432"

  ordering-service:
    build:
      context: ..
      dockerfile: services/ordering-service/Dockerfile
    environment:
      - ORDERING_DB_URL=jdbc:postgresql://ordering-db:5432/ordering
      - ORDERING_DB_USERNAME=ordering
      - ORDERING_DB_PASSWORD=ordering
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - RESTAURANT_SERVICE_URL=http://restaurant-service:8081
    depends_on:
      - ordering-db
      - kafka
    ports:
      - "8080:8080"

  restaurant-service:
    build:
      context: ..
      dockerfile: services/restaurant-service/Dockerfile
    environment:
      - RESTAURANT_DB_URL=jdbc:postgresql://restaurant-db:5432/restaurant
      - RESTAURANT_DB_USERNAME=restaurant
      - RESTAURANT_DB_PASSWORD=restaurant
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
    depends_on:
      - restaurant-db
      - kafka
    ports:
      - "8081:8081"

  notification-service:
    build:
      context: ..
      dockerfile: services/notification-service/Dockerfile
    environment:
      - NOTIFICATION_DB_URL=jdbc:postgresql://notification-db:5432/notification
      - NOTIFICATION_DB_USERNAME=notification
      - NOTIFICATION_DB_PASSWORD=notification
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
    depends_on:
      - notification-db
      - kafka
    ports:
      - "8082:8082"

  api-gateway:
    image: traefik:v3.0
    command:
      - --providers.file.directory=/config
      - --entrypoints.web.address=:80
    ports:
      - "8088:80"
    volumes:
      - ./api-gateway/traefik.yml:/config/traefik.yml:ro
    depends_on:
      - ordering-service
      - restaurant-service
      - notification-service
